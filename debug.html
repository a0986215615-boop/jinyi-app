<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»çµ±è¨ºæ–·å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        h2 {
            margin-top: 0;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        button {
            background: #0070f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        button:hover {
            background: #0051a2;
        }

        button.secondary {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            background: #f9f9f9;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .success {
            color: green;
            background: #e6fffa;
            border: 1px solid #b2f5ea;
        }

        .error {
            color: red;
            background: #fff5f5;
            border: 1px solid #feb2b2;
        }

        input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 300px;
        }
    </style>
</head>

<body>
    <h1>ğŸ› ï¸ ç³»çµ±è¨ºæ–·å·¥å…·</h1>
    <p>æ­¤å·¥å…·ç”¨æ–¼æ¸¬è©¦ Supabase è³‡æ–™åº«å’Œ Gemini AI çš„é€£æ¥ç‹€æ…‹ã€‚</p>

    <!-- ç’°å¢ƒè®Šé‡æª¢æŸ¥ -->
    <div class="card">
        <h2>1. ç’°å¢ƒè®Šé‡æª¢æŸ¥</h2>
        <div id="env-status" class="status">é»æ“Šä¸‹æ–¹æŒ‰éˆ•æª¢æŸ¥...</div>
        <div style="margin-top: 15px;">
            <button onclick="checkEnv()">æª¢æŸ¥è®Šé‡</button>
        </div>
    </div>

    <!-- Supabase æ¸¬è©¦ -->
    <div class="card">
        <h2>2. Supabase è³‡æ–™åº«æ¸¬è©¦</h2>
        <div id="supabase-status" class="status">ç­‰å¾…æ¸¬è©¦...</div>
        <div style="margin-top: 15px;">
            <button onclick="testSupabase()">æ¸¬è©¦é€£æ¥ & å¯«å…¥</button>
            <button class="secondary" onclick="readSupabase()">è®€å–æ•¸æ“š</button>
        </div>
    </div>

    <!-- Gemini æ¸¬è©¦ -->
    <div class="card">
        <h2>3. Gemini AI æ¸¬è©¦</h2>
        <p>è¼¸å…¥æ¸¬è©¦ç—‡ç‹€ï¼ˆä¾‹å¦‚ï¼šé ­ç—›ã€ç™¼ç‡’ï¼‰ï¼š</p>
        <input type="text" id="symptom-input" value="æˆ‘çš„ç‹—ç‹—ä¸€ç›´åï¼Œä¸æƒ³åƒæ±è¥¿">
        <div id="gemini-status" class="status">ç­‰å¾…æ¸¬è©¦...</div>
        <div style="margin-top: 15px;">
            <button onclick="testGemini()">æ¸¬è©¦ AI åˆ†æ</button>
        </div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯ (éƒ¨ç½²æ™‚æœƒç”± Vite æ›¿æ›ï¼Œä½†åœ¨é€™è£¡æˆ‘å€‘éœ€è¦æ‰‹å‹•å¡«å…¥æˆ–å¾ localStorage è®€å–)
        // æ³¨æ„ï¼šåœ¨ç´” HTML ä¸­ç„¡æ³•ç›´æ¥è®€å– .envï¼Œæ‰€ä»¥æˆ‘å€‘å˜—è©¦å¾ URL åƒæ•¸æˆ–æ‰‹å‹•è¼¸å…¥ç²å–

        let SUPABASE_URL = 'https://zntvofpaohnouepquxke.supabase.co';
        let SUPABASE_KEY = 'sb_publishable_TZOgnWwcDA1bRfHghcRSyg_lbmnh4jb';
        let GEMINI_KEY = ''; // éœ€è¦ç”¨æˆ¶è¼¸å…¥æˆ–å¾ä¹‹å‰çš„æ­¥é©Ÿç²å–

        function log(elementId, message, type = 'normal') {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.className = 'status ' + type;
        }

        function checkEnv() {
            let msg = `Supabase URL: ${SUPABASE_URL ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}\n`;
            msg += `Supabase Key: ${SUPABASE_KEY ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}\n`;

            // å˜—è©¦å¾ localStorage ç²å– Gemini Key å¦‚æœæœ‰
            const storedKey = localStorage.getItem('gemini_key');
            if (storedKey) GEMINI_KEY = storedKey;

            if (!GEMINI_KEY) {
                GEMINI_KEY = prompt("è«‹è¼¸å…¥æ‚¨çš„ Gemini API Key é€²è¡Œæ¸¬è©¦:");
                if (GEMINI_KEY) localStorage.setItem('gemini_key', GEMINI_KEY);
            }

            msg += `Gemini Key: ${GEMINI_KEY ? 'âœ… å·²é…ç½® (' + GEMINI_KEY.slice(0, 5) + '...)' : 'âŒ æœªé…ç½®'}`;

            log('env-status', msg, GEMINI_KEY && SUPABASE_URL ? 'success' : 'error');
        }

        async function testSupabase() {
            if (!SUPABASE_URL || !SUPABASE_KEY) {
                log('supabase-status', 'éŒ¯èª¤ï¼šç¼ºå°‘ Supabase é…ç½®', 'error');
                return;
            }

            try {
                const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                log('supabase-status', 'æ­£åœ¨é€£æ¥ Supabase...');

                const testId = 'test-' + Math.random().toString(36).substr(2, 9);
                const { data, error } = await client
                    .from('user_data')
                    .upsert({
                        user_id: testId,
                        data: { test: true, timestamp: new Date().toISOString() }
                    })
                    .select();

                if (error) throw error;

                log('supabase-status', `âœ… é€£æ¥æˆåŠŸï¼\nå·²å¯«å…¥æ¸¬è©¦æ•¸æ“š ID: ${testId}\nå›å‚³: ${JSON.stringify(data, null, 2)}`, 'success');
            } catch (e) {
                log('supabase-status', `âŒ é€£æ¥å¤±æ•—: ${e.message}`, 'error');
            }
        }

        async function readSupabase() {
            try {
                const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const { data, error } = await client.from('user_data').select('count', { count: 'exact' });

                if (error) throw error;
                log('supabase-status', `âœ… è®€å–æˆåŠŸï¼\nè³‡æ–™è¡¨ä¸­æœ‰ ${data.length} ç­†æ•¸æ“š (æˆ–æ›´å¤š)`, 'success');
            } catch (e) {
                log('supabase-status', `âŒ è®€å–å¤±æ•—: ${e.message}`, 'error');
            }
        }

        async function testGemini() {
            if (!GEMINI_KEY) {
                checkEnv();
                if (!GEMINI_KEY) return;
            }

            const symptom = document.getElementById('symptom-input').value;
            log('gemini-status', 'æ­£åœ¨å‘¼å« Gemini API...');

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: `åˆ†æé€™å€‹ç—‡ç‹€ä¸¦æ¨è–¦ç§‘åˆ¥ï¼š${symptom}ã€‚åªå›å‚³ JSON æ ¼å¼ï¼š{"department": "ç§‘åˆ¥åç¨±", "reason": "åŸå› "}` }]
                        }]
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                const resultText = data.candidates[0].content.parts[0].text;
                log('gemini-status', `âœ… åˆ†ææˆåŠŸï¼\nå›å‚³çµæœ:\n${resultText}`, 'success');
            } catch (e) {
                log('gemini-status', `âŒ åˆ†æå¤±æ•—: ${e.message}`, 'error');
            }
        }
    </script>
</body>

</html>